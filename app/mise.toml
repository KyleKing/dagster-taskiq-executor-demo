# App-specific mise configuration
# This file defines tasks for the Dagster TaskIQ application

[env]
PYTHONPATH = "src"

# ==============================================================================
# Development Tasks
# ==============================================================================

[tasks.install]
description = "Install app dependencies"
alias = "i"
run = "uv sync --all-groups"
sources = ["pyproject.toml", "uv.lock"]

[tasks.test]
description = "Run app tests with pytest"
alias = "t"
run = "uv run pytest"
sources = ["src/**/*.py", "tests/**/*.py"]

[tasks.lint]
description = "Lint app code with ruff"
alias = "l"
run = "uv run ruff check ."
sources = ["src/**/*.py", "tests/**/*.py"]

[tasks."lint:fix"]
description = "Lint and auto-fix issues"
run = "uv run ruff check --fix ."
sources = ["src/**/*.py", "tests/**/*.py"]

[tasks.format]
description = "Format app code with ruff"
alias = "f"
run = "uv run ruff format ."
sources = ["src/**/*.py", "tests/**/*.py"]

[tasks."format:check"]
description = "Check formatting without modifying files"
run = "uv run ruff format --check ."
sources = ["src/**/*.py", "tests/**/*.py"]

[tasks.typecheck]
description = "Run type checkers (mypy + pyright)"
alias = "tc"
run = [
    "uv run mypy src",
    "uv run pyright",
]
sources = ["src/**/*.py"]

[tasks."typecheck:mypy"]
description = "Run mypy type checker"
run = "uv run mypy src"
sources = ["src/**/*.py"]

[tasks."typecheck:pyright"]
description = "Run pyright type checker"
run = "uv run pyright"
sources = ["src/**/*.py"]

[tasks.check]
description = "Run all checks (lint + typecheck + test)"
alias = "c"
depends = ["lint", "typecheck", "test"]

# ==============================================================================
# Utility Tasks
# ==============================================================================

[tasks.clean]
description = "Clean build artifacts and caches"
run = [
    "find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type d -name '.pytest_cache' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type d -name '.ruff_cache' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type d -name '.mypy_cache' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type f -name '*.pyc' -delete 2>/dev/null || true",
    "echo 'Cleaned app caches and artifacts'",
]

[tasks."clean:venv"]
description = "Remove virtual environment"
confirm = "This will remove the app virtual environment. Continue?"
run = "rm -rf .venv"

# ==============================================================================
# CI Tasks
# ==============================================================================

[tasks.ci]
description = "Run all CI checks for app"
run = [
    "echo '==> Formatting app code...'",
    "uv run ruff format .",
    "echo '==> Linting app code...'",
    "uv run ruff check .",
    "echo '==> Type checking app code...'",
    "uv run mypy src",
    "uv run pyright",
    "echo '==> Running app tests...'",
    "uv run pytest",
    "echo 'âœ“ All app CI checks passed!'",
]
