# Deploy-specific mise configuration
# This file defines tasks for Pulumi infrastructure deployment

# ==============================================================================
# Common Development Tasks
# ==============================================================================

[tasks.install]
description = "Install deploy dependencies"
run = "uv sync --all-groups"
sources = ["pyproject.toml", "uv.lock"]

[tasks.test]
description = "Run deploy tests with pytest (pass additional args)"
run = "uv run pytest"
sources = ["**/*.py"]

[tasks.format]
description = "Format deploy code with ruff (pass --check to check only)"
run = "uv run ruff format"
sources = ["**/*.py"]

[tasks.lint]
description = "Lint deploy code with ruff (pass --fix to auto-fix)"
run = "uv run ruff check"
sources = ["**/*.py"]

[tasks."lint:power-fix"]
description = "Attempt to fix all lint errors"
run = "mise run lint --fix --unsafe-fixes"

[tasks.mypy]
description = "Run mypy type checker (pass additional args)"
run = "uv run mypy"
sources = ["**/*.py"]

[tasks.pyright]
description = "Run pyright type checker (pass additional args)"
run = "uv run pyright"
sources = ["**/*.py"]

[tasks.checks]
description = "Run all read-only checks (lint + typechecks + test)"
depends = ["lint", "mypy", "pyright", "test"]

[tasks.fixes]
description = "Run all fixes (ruff format and linter)"
depends = ["format", "lint:power-fix"]

# ==============================================================================
# Infrastructure Tasks (Pulumi)
# ==============================================================================

[tasks."pulumi:up"]
description = "Deploy infrastructure with Pulumi (update)"
run = "uv run pulumi up --yes --stack local"
env = { PULUMI_CONFIG_PASSPHRASE = "localstack" }

[tasks."pulumi:down"]
description = "Destroy infrastructure with Pulumi"
confirm = "Are you sure you want to destroy the infrastructure?"
run = "uv run pulumi destroy --yes --stack local"
env = { PULUMI_CONFIG_PASSPHRASE = "localstack" }

[tasks."pulumi:preview"]
description = "Preview infrastructure changes"
run = "uv run pulumi preview --stack local"
env = { PULUMI_CONFIG_PASSPHRASE = "localstack" }

[tasks."pulumi:refresh"]
description = "Refresh Pulumi state"
run = "uv run pulumi refresh --yes --stack local"
env = { PULUMI_CONFIG_PASSPHRASE = "localstack" }

[tasks."pulumi:outputs"]
description = "Show Pulumi stack outputs"
run = "uv run pulumi stack output --stack local"
env = { PULUMI_CONFIG_PASSPHRASE = "localstack" }

[tasks."pulumi:config"]
description = "Show Pulumi configuration"
run = "uv run pulumi config --stack local"
env = { PULUMI_CONFIG_PASSPHRASE = "localstack" }

[tasks."pulumi:reset"]
description = "Reset LocalStack and Pulumi state"
confirm = "This will delete all LocalStack and Pulumi data. Continue?"
run = [
  "rm -rf volume/*",
  "mise run localstack:start --detach",
]
wait_for = ["localstack:stop"]
depends_post = ["pulumi:refresh"]
