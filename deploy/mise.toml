# Deploy-specific mise configuration
# This file defines tasks for Pulumi infrastructure deployment

# ==============================================================================
# Development Tasks
# ==============================================================================

[tasks.install]
description = "Install deploy dependencies"
alias = "i"
run = "uv sync --all-groups"
sources = ["pyproject.toml", "uv.lock"]

[tasks.test]
description = "Run deploy tests with pytest"
alias = "t"
run = "uv run pytest"
sources = ["**/*.py", "tests/**/*.py"]

[tasks.lint]
description = "Lint deploy code with ruff"
alias = "l"
run = "uv run ruff check ."
sources = ["**/*.py", "tests/**/*.py"]

[tasks."lint:fix"]
description = "Lint and auto-fix issues"
run = "uv run ruff check --fix ."
sources = ["**/*.py", "tests/**/*.py"]

[tasks.format]
description = "Format deploy code with ruff"
alias = "f"
run = "uv run ruff format ."
sources = ["**/*.py", "tests/**/*.py"]

[tasks."format:check"]
description = "Check formatting without modifying files"
run = "uv run ruff format --check ."
sources = ["**/*.py", "tests/**/*.py"]

[tasks.typecheck]
description = "Run type checkers (mypy + pyright)"
alias = "tc"
run = [
    "uv run mypy .",
    "uv run pyright",
]
sources = ["**/*.py"]

[tasks."typecheck:mypy"]
description = "Run mypy type checker"
run = "uv run mypy ."
sources = ["**/*.py"]

[tasks."typecheck:pyright"]
description = "Run pyright type checker"
run = "uv run pyright"
sources = ["**/*.py"]

[tasks.check]
description = "Run all checks (lint + typecheck + test)"
alias = "c"
depends = ["lint", "typecheck", "test"]

# ==============================================================================
# Infrastructure Tasks (Pulumi)
# ==============================================================================

[tasks.up]
description = "Deploy infrastructure with Pulumi"
alias = "u"
run = "uv run pulumi up --yes --stack local"

[tasks.down]
description = "Destroy infrastructure with Pulumi"
alias = "d"
confirm = "Are you sure you want to destroy the infrastructure?"
run = "uv run pulumi destroy --yes --stack local"

[tasks.preview]
description = "Preview infrastructure changes"
alias = "p"
run = "uv run pulumi preview --stack local"

[tasks.refresh]
description = "Refresh Pulumi state"
run = "uv run pulumi refresh --yes --stack local"

[tasks.outputs]
description = "Show Pulumi stack outputs"
alias = "o"
run = "uv run pulumi stack output --stack local"

[tasks.config]
description = "Show Pulumi configuration"
run = "uv run pulumi config --stack local"

# ==============================================================================
# Utility Tasks
# ==============================================================================

[tasks.clean]
description = "Clean build artifacts and caches"
run = [
    "find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type d -name '.pytest_cache' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type d -name '.ruff_cache' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type d -name '.mypy_cache' -exec rm -rf {} + 2>/dev/null || true",
    "find . -type f -name '*.pyc' -delete 2>/dev/null || true",
    "echo 'Cleaned deploy caches and artifacts'",
]

[tasks."clean:venv"]
description = "Remove virtual environment"
confirm = "This will remove the deploy virtual environment. Continue?"
run = "rm -rf .venv"

# ==============================================================================
# CI Tasks
# ==============================================================================

[tasks.ci]
description = "Run all CI checks for deploy"
run = [
    "echo '==> Formatting deploy code...'",
    "uv run ruff format .",
    "echo '==> Linting deploy code...'",
    "uv run ruff check .",
    "echo '==> Type checking deploy code...'",
    "uv run mypy .",
    "uv run pyright",
    "echo '==> Running deploy tests...'",
    "uv run pytest",
    "echo 'âœ“ All deploy CI checks passed!'",
]
