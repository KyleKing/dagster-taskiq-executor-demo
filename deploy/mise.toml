[env]
PROJECT_NAME = "dagster-taskiq-demo"
PULUMI_CONFIG_PASSPHRASE = "See README!"

[task_config]
includes = ["../tasks.toml"]

[tasks."pulumi:config"]
description = "Show Pulumi configuration"
run = "uv run pulumi config --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:down"]
description = "Destroy infrastructure with Pulumi"
confirm = "Are you sure you want to destroy the infrastructure?"
run = "uv run pulumi destroy --yes --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:outputs"]
description = "Show Pulumi stack outputs"
run = "uv run pulumi stack output --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:preview"]
description = "Preview infrastructure changes"
run = "uv run pulumi preview --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:refresh"]
description = "Refresh Pulumi state to sync with actual infrastructure"
run = "uv run pulumi refresh --yes --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:reset"]
description = "Reset LocalStack and Pulumi state (alias for soft reset)"
run = "pulumi:reset:soft"

[tasks."pulumi:reset:hard"]
description = "Hard reset: delete stack, clean LocalStack, recreate everything"
confirm = "This will DELETE the Pulumi stack and all LocalStack data. Continue?"
run = [
  "pitchfork stop localstack || true",
  "rm -rf volume/*",
  "uv run pulumi stack rm --yes --stack local || true",
  "pitchfork start localstack",
  "sleep 5",
  "pulumi:state:init"
]

[tasks."pulumi:reset:soft"]
description = "Soft reset: destroy resources, refresh state, then redeploy"
confirm = "This will destroy all Pulumi-managed resources and refresh state. Continue?"
run = [
  "pulumi:down",
  "pitchfork stop localstack",
  "rm -rf volume/*",
  "pitchfork start localstack",
  "sleep 5",
  "pulumi:state:init",
  "pulumi:refresh"
]

[tasks."pulumi:state:delete"]
description = "Delete Pulumi stack (removes state, does not destroy resources)"
confirm = "This will delete the Pulumi stack state. Resources may remain in LocalStack. Continue?"
run = "uv run pulumi stack rm --yes --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:state:init"]
description = "Initialize Pulumi stack if it doesn't exist"
run = "uv run pulumi stack init local || true"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:state:list"]
description = "List all resources in Pulumi state"
run = "uv run pulumi stack --show-urns --stack local || uv run pulumi stack --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:state:repair"]
description = "Attempt to repair corrupted Pulumi state"
run = "uv run pulumi state repair --yes --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:up"]
description = "Deploy infrastructure with Pulumi (update)"
run = "uv run pulumi up --yes --stack local"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}

[tasks."pulumi:validate"]
description = "Validate Pulumi state and detect issues (preview without applying)"
run = "uv run pulumi preview --stack local --diff"
env = {PULUMI_CONFIG_PASSPHRASE = "localstack"}
