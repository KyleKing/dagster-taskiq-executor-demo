# Root mise.toml - Monorepo Orchestration
# This file coordinates tasks across the entire repository

[settings]
experimental = true

[tools]
"asdf:postgres" = "17"
node = "latest"
"pipx:awscli-local" = "latest"
"pipx:toml-sort" = "latest"
python = "3.13"

[env]
_.file = { path = ".env" }
AWS_DEFAULT_REGION = "us-east-1"
ENVIRONMENT = "local"
PROJECT_NAME = "dagster-taskiq-demo"
PULUMI_CONFIG_PASSPHRASE = "See README!"

# ==============================================================================
# Meta-Tasks for Mise Management
# ==============================================================================

[tasks."mise:bump"]
description = "Bump all tool versions to latest and update mise.toml/lock"
run = "mise up --bump"

# ==============================================================================
# General Utilities
# ==============================================================================

[tasks.toml-sort]
description = "Format all toml files"
# FYI: Currently only formats pyproject.toml because mise.toml are manually sorted
run = "toml-sort --in-place **/pyproject.toml"

# ==============================================================================
# Monorepo Orchestration Tasks
# These tasks coordinate work across dagster-taskiq-demo/ and deploy/ subdirectories
# ==============================================================================

[tasks.install]
description = "Install all dependencies (dagster-taskiq-demo + deploy + dagster-taskiq)"
run = [
    "mise -C dagster-taskiq-demo run install",
    "mise -C taskiq-demo run install",
    "mise -C deploy run install",
    "mise -C dagster-taskiq run install",
]

[tasks.checks]
description = "Check all code (dagster-taskiq-demo + deploy + dagster-taskiq)"
run = [
    "mise -C dagster-taskiq-demo run checks",
    "mise -C taskiq-demo run checks",
    "mise -C deploy run checks",
    "mise -C dagster-taskiq run checks",
]

[tasks.fixes]
description = "Lint and auto-fix all code (dagster-taskiq-demo + deploy + dagster-taskiq)"
run = [
    "mise -C dagster-taskiq-demo run fixes",
    "mise -C taskiq-demo run fixes",
    "mise -C deploy run fixes",
    "mise -C dagster-taskiq run fixes",
]

# ==============================================================================
# Docker & Build Tasks
# PLANNED: de-duplicate with build and push script
# ==============================================================================

[tasks.build]
description = "Build Docker image with docker bake"
run = "docker buildx bake dagster-taskiq-demo"
sources = ["dagster-taskiq-demo/**/*", "docker-bake.hcl", "dagster-taskiq-demo/Dockerfile"]
outputs = ["docker image ls dagster-taskiq-demo:latest -q"]

[tasks."build:taskiq-demo"]
description = "Build TaskIQ demo image with docker bake"
run = "docker buildx bake taskiq-demo"
sources = ["taskiq-demo/**/*", "docker-bake.hcl", "taskiq-demo/Dockerfile"]

[tasks."docker:login"]
description = "Login to LocalStack ECR"
hide = true
run = '''
REPO_NAME="${PROJECT_NAME}-${ENVIRONMENT}"
REPO_URI=$(awslocal ecr describe-repositories \
  --region ${AWS_DEFAULT_REGION} \
  --repository-names "${REPO_NAME}" \
  --query 'repositories[0].repositoryUri' \
  --output text 2>/dev/null || echo "")
if [ -n "$REPO_URI" ]; then
  awslocal ecr get-login-password --region ${AWS_DEFAULT_REGION} | \
    docker login --username AWS --password-stdin "${REPO_URI%%/*}"
else
  echo "ECR repository not found. Run 'mise run infra:up' first."
  exit 1
fi
'''

[tasks.push]
description = "Build and push Docker image to LocalStack ECR"
depends = ["build"]
run = "./scripts/build-and-push.sh"

[tasks."push:taskiq-demo"]
description = "Build and push TaskIQ demo image to LocalStack ECR"
run = "BAKE_TARGET=taskiq-demo IMAGE_TAG=${TASKIQ_DEMO_IMAGE_TAG:-taskiq-demo} ./scripts/build-and-push.sh"

# ==============================================================================
# LocalStack Service Management (via Docker Compose)
# ==============================================================================

[tasks."localstack:start"]
description = "Start LocalStack container"
alias = "start"
run = "docker compose up --build --remove-orphans"

[tasks."localstack:stop"]
description = "Stop LocalStack container"
alias = "stop"
run = "docker compose down"

[tasks."localstack:restart"]
description = "Restart LocalStack container"
depends = ["localstack:stop", "localstack:start"]

[tasks."localstack:logs"]
description = "View LocalStack logs"
alias = "logs"
run = "docker compose logs -f localstack"

[tasks."localstack:status"]
description = "Check LocalStack health"
run = '''
echo "Checking LocalStack health..."
(curl -s http://localhost:4566/_localstack/health | jq) || echo "LocalStack not running"
'''

# PLANNED: Consider similar helper for Pulumi to remove (forget) the pulumi stack when LocalStack is purged
[tasks."localstack:reset"]
description = "Reset LocalStack state (removes volume data)"
confirm = "This will delete all LocalStack data. Continue?"
run = [
    "mise run localstack:stop",
    "rm -rf volume/*",
    "mise run localstack:start",
]

# ==============================================================================
# AWS/LocalStack Utility Tasks
# ==============================================================================

[tasks."aws:queues"]
description = "List SQS queues in LocalStack"
run = "awslocal sqs list-queues --region ${AWS_DEFAULT_REGION}"

[tasks."aws:clusters"]
description = "List ECS clusters in LocalStack"
run = "awslocal ecs list-clusters --region ${AWS_DEFAULT_REGION}"

[tasks."aws:images"]
description = "List ECR images"
run = "awslocal ecr list-images --repository-name ${PROJECT_NAME}-${ENVIRONMENT} --region ${AWS_DEFAULT_REGION}"

[tasks."aws:services"]
description = "List ECS services in the cluster"
run = "awslocal ecs list-services --cluster ${ECS_CLUSTER_NAME:-dagster-taskiq-demo-dev} --region ${AWS_DEFAULT_REGION}"

[tasks."aws:tasks"]
description = "List running ECS tasks"
run = "awslocal ecs list-tasks --cluster ${ECS_CLUSTER_NAME:-dagster-taskiq-demo-dev} --region ${AWS_DEFAULT_REGION}"

# TODO: Consider other helpers for logs and possibly reading from Pulumi Outputs for the values instead of ENV

# ==============================================================================
# Composite Workflow Tasks
# ==============================================================================

[tasks.env-setup]
description = "Initial project setup (check env, install deps)"
run = [
    "test -f .env || (echo 'Creating .env from .env.example...' && cp .env.example .env && echo 'Please edit .env with your LOCALSTACK_AUTH_TOKEN')",
    "mise install",
]

[tasks."demo:taskiq"]
description = "Deploy the TaskIQ demo (LocalStack, image push, Pulumi up, outputs)"
run = [
    "docker compose up -d localstack",
    "BAKE_TARGET=taskiq-demo IMAGE_TAG=${TASKIQ_DEMO_IMAGE_TAG:-taskiq-demo} ./scripts/build-and-push.sh",
    "mise -C deploy run pulumi:up",
    "mise -C deploy run pulumi:outputs",
]
