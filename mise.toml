# Root mise.toml - Monorepo Orchestration
# This file coordinates tasks across the entire repository

# Enable experimental monorepo support for task namespacing
# Requires: MISE_EXPERIMENTAL=1 environment variable
experimental_monorepo_root = true

[tools]
"asdf:postgres" = "17"
node = "latest"
"pipx:awscli-local" = "latest"
python = "3.13"

[env]
_.file = { path = ".env", redact = true }
MISE_EXPERIMENTAL = "1"
PULUMI_CONFIG_PASSPHRASE = "See README!"
AWS_DEFAULT_REGION = "us-east-1"
PROJECT_NAME = "dagster-taskiq-demo"
ENVIRONMENT = "local"

# ==============================================================================
# Monorepo Orchestration Tasks
# These tasks coordinate work across app/ and deploy/ subdirectories
# ==============================================================================

[tasks.install]
description = "Install all dependencies (app + deploy)"
alias = "i"
run = [
    "mise run //app:install",
    "mise run //deploy:install",
]

[tasks.test]
description = "Run all tests (app + deploy)"
alias = "t"
run = [
    "mise run //app:test",
    "mise run //deploy:test",
]

[tasks.lint]
description = "Lint all code (app + deploy)"
alias = "l"
run = [
    "mise run //app:lint",
    "mise run //deploy:lint",
]

[tasks."lint:fix"]
description = "Lint and auto-fix all code"
run = [
    "mise run //app:lint:fix",
    "mise run //deploy:lint:fix",
]

[tasks.format]
description = "Format all code (app + deploy)"
alias = "f"
run = [
    "mise run //app:format",
    "mise run //deploy:format",
]

[tasks."format:check"]
description = "Check formatting without modifying files"
run = [
    "mise run //app:format:check",
    "mise run //deploy:format:check",
]

[tasks.typecheck]
description = "Type check all code (app + deploy)"
alias = "tc"
run = [
    "mise run //app:typecheck",
    "mise run //deploy:typecheck",
]

[tasks.check]
description = "Run all checks (lint + typecheck + test)"
alias = "c"
depends = ["lint", "typecheck", "test"]

# ==============================================================================
# Docker & Build Tasks
# ==============================================================================

[tasks.build]
description = "Build Docker image with docker bake"
alias = "b"
run = "docker buildx bake app"
sources = ["app/**/*", "docker-bake.hcl", "app/Dockerfile"]
outputs = ["docker image ls dagster-taskiq-demo:latest -q"]

[tasks."docker:login"]
description = "Login to LocalStack ECR"
hide = true
run = '''
REPO_NAME="${PROJECT_NAME}-${ENVIRONMENT}"
REPO_URI=$(awslocal ecr describe-repositories \
  --region ${AWS_DEFAULT_REGION} \
  --repository-names "${REPO_NAME}" \
  --query 'repositories[0].repositoryUri' \
  --output text 2>/dev/null || echo "")
if [ -n "$REPO_URI" ]; then
  awslocal ecr get-login-password --region ${AWS_DEFAULT_REGION} | \
    docker login --username AWS --password-stdin "${REPO_URI%%/*}"
else
  echo "ECR repository not found. Run 'mise run infra:up' first."
  exit 1
fi
'''

[tasks.push]
description = "Build and push Docker image to LocalStack ECR"
alias = "p"
depends = ["build"]
run = "./scripts/build-and-push.sh"

# ==============================================================================
# Infrastructure Tasks (Pulumi)
# Delegates to deploy/mise.toml but provides convenience aliases
# ==============================================================================

[tasks.up]
description = "Deploy infrastructure with Pulumi"
alias = "infra:up"
run = "mise run //deploy:up"

[tasks.down]
description = "Destroy infrastructure with Pulumi"
alias = "infra:down"
confirm = "Are you sure you want to destroy the infrastructure?"
run = "mise run //deploy:down"

[tasks.preview]
description = "Preview infrastructure changes"
alias = "infra:preview"
run = "mise run //deploy:preview"

[tasks.refresh]
description = "Refresh Pulumi state"
run = "mise run //deploy:refresh"

[tasks.outputs]
description = "Show Pulumi stack outputs"
run = "mise run //deploy:outputs"

# ==============================================================================
# LocalStack Service Management
# ==============================================================================

[tasks."localstack:start"]
description = "Start LocalStack container"
alias = "start"
run = "docker compose up -d localstack"

[tasks."localstack:stop"]
description = "Stop LocalStack container"
alias = "stop"
run = "docker compose down"

[tasks."localstack:restart"]
description = "Restart LocalStack container"
depends = ["localstack:stop", "localstack:start"]

[tasks."localstack:logs"]
description = "View LocalStack logs"
alias = "logs"
run = "docker compose logs -f localstack"

[tasks."localstack:status"]
description = "Check LocalStack health"
run = '''
echo "Checking LocalStack health..."
curl -s http://localhost:4566/_localstack/health | python3 -m json.tool || echo "LocalStack not running"
'''

[tasks."localstack:reset"]
description = "Reset LocalStack state (removes volume data)"
confirm = "This will delete all LocalStack data. Continue?"
run = [
    "docker compose down -v",
    "rm -rf volume/*",
    "docker compose up -d localstack",
]

# ==============================================================================
# AWS/LocalStack Utility Tasks
# ==============================================================================

[tasks."aws:queues"]
description = "List SQS queues in LocalStack"
run = "awslocal sqs list-queues --region ${AWS_DEFAULT_REGION}"

[tasks."aws:clusters"]
description = "List ECS clusters in LocalStack"
run = "awslocal ecs list-clusters --region ${AWS_DEFAULT_REGION}"

[tasks."aws:images"]
description = "List ECR images"
run = "awslocal ecr list-images --repository-name ${PROJECT_NAME}-${ENVIRONMENT} --region ${AWS_DEFAULT_REGION}"

[tasks."aws:services"]
description = "List ECS services in the cluster"
run = "awslocal ecs list-services --cluster ${ECS_CLUSTER_NAME:-dagster-taskiq-demo-dev} --region ${AWS_DEFAULT_REGION}"

[tasks."aws:tasks"]
description = "List running ECS tasks"
run = "awslocal ecs list-tasks --cluster ${ECS_CLUSTER_NAME:-dagster-taskiq-demo-dev} --region ${AWS_DEFAULT_REGION}"

# ==============================================================================
# Composite Workflow Tasks
# ==============================================================================

[tasks.setup]
description = "Initial project setup (check env, install deps)"
run = [
    "test -f .env || (echo 'Creating .env from .env.example...' && cp .env.example .env && echo 'Please edit .env with your LOCALSTACK_AUTH_TOKEN')",
    "mise install",
]
depends = ["install"]

[tasks.dev]
description = "Start development environment (LocalStack + deps)"
depends = ["localstack:start", "install"]
run = '''
echo "Waiting for LocalStack to be ready..."
timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health > /dev/null 2>&1; do sleep 1; done' || {
  echo "LocalStack failed to start"
  exit 1
}
echo "LocalStack is ready!"
echo "Run 'mise run infra:up' to deploy infrastructure"
echo "Run 'mise run push' to build and push the Docker image"
'''

[tasks.deploy]
description = "Full deployment workflow (build, infra, push)"
depends = ["localstack:start", "up", "push"]
run = "echo 'Deployment complete! Check services: mise run aws:services'"

[tasks.clean]
description = "Clean build artifacts and caches in all projects"
run = [
    "mise run //app:clean",
    "mise run //deploy:clean",
    "echo 'Cleaned all project caches and artifacts'",
]

[tasks."clean:all"]
description = "Clean everything including venvs and Docker"
confirm = "This will remove all virtual environments and Docker images. Continue?"
depends = ["clean"]
run = [
    "mise run //app:clean:venv 2>/dev/null || true",
    "mise run //deploy:clean:venv 2>/dev/null || true",
    "docker image rm dagster-taskiq-demo:latest 2>/dev/null || true",
    "echo 'Cleaned all build artifacts, venvs, and Docker images'",
]

# ==============================================================================
# CI/CD Tasks
# ==============================================================================

[tasks.ci]
description = "Run all CI checks (format, lint, typecheck, test)"
run = [
    "echo '==> Running CI checks across all projects...'",
    "mise run //app:ci",
    "mise run //deploy:ci",
    "echo 'âœ“ All CI checks passed!'",
]
