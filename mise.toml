# Root mise.toml - Monorepo Orchestration
# This file coordinates tasks across the entire repository

[env]
AWS_DEFAULT_REGION = "us-east-1"
ENVIRONMENT = "local"
PROJECT_NAME = "dagster-taskiq-demo"
PULUMI_CONFIG_PASSPHRASE = "See README!"
_.file = {path = ".env"}

[settings]
experimental = true

[tasks."aws:clusters"]
description = "List ECS clusters in LocalStack"
run = "awslocal ecs list-clusters --region ${AWS_DEFAULT_REGION}"

[tasks."aws:images"]
description = "List ECR images"
run = "awslocal ecr list-images --repository-name ${PROJECT_NAME}-${ENVIRONMENT} --region ${AWS_DEFAULT_REGION}"

[tasks."aws:queues"]
description = "List SQS queues in LocalStack"
run = "awslocal sqs list-queues --region ${AWS_DEFAULT_REGION}"

[tasks."aws:services"]
description = "List ECS services in the cluster"
run = "awslocal ecs list-services --cluster ${ECS_CLUSTER_NAME:-dagster-taskiq-demo-dev} --region ${AWS_DEFAULT_REGION}"

[tasks."aws:tasks"]
description = "List running ECS tasks"
run = "awslocal ecs list-tasks --cluster ${ECS_CLUSTER_NAME:-dagster-taskiq-demo-dev} --region ${AWS_DEFAULT_REGION}"

[tasks."build:dagster-taskiq-demo"]
description = "Build Docker image with docker bake"
run = "docker buildx bake dagster-taskiq-demo"
sources = ["dagster-taskiq-demo/**/*", "docker-bake.hcl", "dagster-taskiq-demo/Dockerfile"]
outputs = ["docker image ls dagster-taskiq-demo:latest -q"]

[tasks."build:taskiq-demo"]
description = "Build TaskIQ demo image with docker bake"
run = "docker buildx bake taskiq-demo"
sources = ["taskiq-demo/**/*", "docker-bake.hcl", "taskiq-demo/Dockerfile"]

[tasks.checks]
description = "Check all projects"
run = [
  "mise -C dagster-taskiq-demo run checks",
  "mise -C taskiq-demo run checks",
  "mise -C deploy run checks",
  "mise -C dagster-taskiq run checks",
  "mise -C dagster-celery-to-taskiq/example run checks"
]

[tasks."ecr:login"]
description = "Login to LocalStack ECR"
hide = true
run = '''
REPO_NAME="${PROJECT_NAME}-${ENVIRONMENT}"
REPO_URI=$(awslocal ecr describe-repositories \
  --region ${AWS_DEFAULT_REGION} \
  --repository-names "${REPO_NAME}" \
  --query 'repositories[0].repositoryUri' \
  --output text 2>/dev/null || echo "")
if [ -n "$REPO_URI" ]; then
  awslocal ecr get-login-password --region ${AWS_DEFAULT_REGION} | \
    docker login --username AWS --password-stdin "${REPO_URI%%/*}"
else
  echo "ECR repository not found. Run 'mise run infra:up' first."
  exit 1
fi
'''

[tasks."ecr:push:dagster-taskiq-demo"]
description = "Build and push Docker image to LocalStack ECR"
depends = ["build"]
run = "./scripts/build-and-push.sh"

[tasks."ecr:push:taskiq-demo"]
description = "Build and push TaskIQ demo image to LocalStack ECR"
run = "BAKE_TARGET=taskiq-demo IMAGE_TAG=${TASKIQ_DEMO_IMAGE_TAG:-taskiq-demo} ./scripts/build-and-push.sh"

[tasks.env-setup]
description = "Initial project setup (check env, install deps)"
run = [
  "test -f .env || (echo 'Creating .env from .env.example...' && cp .env.example .env && echo 'Please edit .env with your LOCALSTACK_AUTH_TOKEN')",
  "mise install"
]

[tasks.test]
description = "Test all projects"
run = [
  "mise -C dagster-taskiq-demo run test",
  "mise -C taskiq-demo run test",
  "mise -C deploy run test",
  "mise -C dagster-taskiq run test",
  "mise -C dagster-celery-to-taskiq/example run test"
]

[tasks.fixes]
description = "Lint and auto-fix all projects"
run = [
  "mise -C dagster-taskiq-demo run fixes",
  "mise -C taskiq-demo run fixes",
  "mise -C deploy run fixes",
  "mise -C dagster-taskiq run fixes",
  "mise -C dagster-celery-to-taskiq/example run fixes"
]

[tasks.install]
description = "Install all project dependencies"
run = [
  "mise -C dagster-taskiq-demo run install",
  "mise -C taskiq-demo run install",
  "mise -C deploy run install",
  "mise -C dagster-taskiq run install",
  "mise -C dagster-celery-to-taskiq/example run install"
]

[tasks."localstack:logs"]
description = "View LocalStack logs"
alias = "logs"
run = "docker compose logs -f localstack"

[tasks."localstack:restart"]
description = "Restart LocalStack container"
run = "mise run localstack:start --detach"
wait_for = ["localstack:stop"]

[tasks."localstack:start"]
description = "Start LocalStack container"
alias = "start"
run = "docker compose up --build --remove-orphans"

[tasks."localstack:status"]
description = "Check LocalStack health"
run = '''
echo "Checking LocalStack health..."
(curl -s http://localhost:4566/_localstack/health | jq) || echo "LocalStack not running"
'''

[tasks."localstack:stop"]
description = "Stop LocalStack container"
alias = "stop"
run = "docker compose down"

[tasks."dashboard:start"]
description = "Start TaskIQ dashboard (requires dev dependencies)"
run = "./scripts/run-dashboard.sh"

[tasks.mdformat]
description = "Format all markdown files"
run = "mdformat **/*.md"
sources = ["**/*.md"]

[tasks."mise:bump"]
description = "Bump all tool versions to latest and update mise.toml/lock"
run = "mise up --bump"

[tasks.toml-sort]
description = "Format all toml files"
# FYI: Currently only formats pyproject.toml because mise.toml are manually sorted
run = "toml-sort --in-place **/pyproject.toml"
sources = ["**/pyproject.toml"]

[tools]
"asdf:postgres" = "17"
hadolint = "latest"
hk = "latest"
node = "latest"
"pipx:awscli-local" = "latest"
"pipx:mdformat" = "latest"
"pipx:toml-sort" = "latest"
python = "3.13"
pkl = "latest"
"pipx:commitizen" = "latest"
